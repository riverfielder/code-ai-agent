# Cursor Agent 项目需求分析与第一周迭代计划

## 📋 项目概述

**项目名称**: Cursor Agent Tools  
**项目描述**: 构建一个开源的Python AI代理框架，能够复制Cursor编辑器的代码助手能力  
**目标用户**: Python开发者、AI应用开发者、代码生成工具使用者  
**目标平台**: Windows/Mac/Linux  
**计划版本**: 0.1.0（MVP 版本）  

---

## 1️⃣ 需求分析

### 1.1 功能需求

#### 核心功能模块 F1：多模型支持引擎
- **F1.1** 支持 Anthropic Claude 模型集成
  - 需要实现与Claude API的连接
  - 需要支持模型版本切换
  - 需要实现消息格式转换
  
- **F1.2** 支持 OpenAI 模型集成
  - 需要实现与OpenAI API的连接
  - 需要支持GPT-4、GPT-4o等模型
  - 需要实现token计算
  
- **F1.3** 支持本地Ollama模型集成
  - 需要实现Ollama API调用
  - 需要支持本地模型部署
  - 需要处理本地模型的启动/关闭

- **F1.4** 统一的模型工厂接口
  - 需要实现工厂模式的模型创建
  - 需要支持动态模型切换
  - 需要统一的API接口

#### 核心功能模块 F2：文件操作工具集
- **F2.1** 文件读取工具
  - 需要支持按行号范围读取
  - 需要支持完整文件读取
  - 需要处理大文件（分块读取）
  - 需要支持多种编码格式
  
- **F2.2** 文件编辑工具
  - 需要支持完整文件替换
  - 需要支持行号范围编辑
  - 需要支持JSON格式编辑指令
  - 需要实现编辑历史跟踪
  
- **F2.3** 文件删除工具
  - 需要实现安全删除机制
  - 需要实现回收站功能
  - 需要添加删除确认
  
- **F2.4** 文件列表工具
  - 需要实现目录浏览
  - 需要支持过滤和排序
  - 需要显示文件大小和修改时间

#### 核心功能模块 F3：代码搜索与分析
- **F3.1** 语义代码搜索
  - 需要实现正则表达式搜索
  - 需要支持模糊匹配
  - 需要支持跨文件搜索
  
- **F3.2** 代码库智能搜索
  - 需要支持关键词搜索
  - 需要支持函数/类定义搜索
  - 需要支持使用情况分析
  
- **F3.3** Web搜索能力
  - 需要集成Google Custom Search API
  - 需要返回相关搜索结果
  - 需要提取摘要和链接

#### 核心功能模块 F4：工具函数调用系统
- **F4.1** 工具注册框架
  - 需要实现工具的动态注册机制
  - 需要支持参数验证
  - 需要支持工具版本管理
  
- **F4.2** 工具执行引擎
  - 需要实现异步执行
  - 需要实现错误捕获和报告
  - 需要实现超时控制
  
- **F4.3** 工具调用接口
  - 需要支持Claude的tool_use格式
  - 需要支持OpenAI的function_calling格式
  - 需要实现格式转换和适配

#### 核心功能模块 F5：对话管理系统
- **F5.1** 对话历史管理
  - 需要存储消息历史
  - 需要支持上下文窗口限制
  - 需要实现历史压缩
  
- **F5.2** 会话管理
  - 需要支持多会话并行
  - 需要实现会话持久化
  - 需要支持会话恢复
  
- **F5.3** 消息格式化
  - 需要支持不同AI模型的消息格式
  - 需要实现富文本消息支持
  - 需要处理特殊字符转义

#### 核心功能模块 F6：权限与安全系统
- **F6.1** 文件操作权限
  - 需要实现权限检查机制
  - 需要支持白名单/黑名单
  - 需要实现目录访问限制
  
- **F6.2** 命令执行权限
  - 需要实现命令白名单
  - 需要实现命令黑名单
  - 需要支持交互式权限请求
  
- **F6.3** YOLO模式（自动批准）
  - 需要实现YOLO模式开关
  - 需要支持自定义批准规则
  - 需要实现操作日志记录

#### 核心功能模块 F7：交互模式
- **F7.1** CLI交互界面
  - 需要实现命令行输入/输出
  - 需要支持颜色输出
  - 需要实现进度显示
  
- **F7.2** 自动继续执行
  - 需要实现链式任务执行
  - 需要支持手动干预
  - 需要显示执行步骤
  
- **F7.3** 用户信息传递
  - 需要支持传递开放文件列表
  - 需要支持传递光标位置
  - 需要支持传递工作空间信息

#### 支持功能模块 F8：图像分析
- **F8.1** 图像查询工具
  - 需要支持多种图像格式
  - 需要实现图像预处理
  - 需要支持视觉模型调用

#### 支持功能模块 F9：日志与监测
- **F9.1** 日志系统
  - 需要实现分级日志
  - 需要支持日志文件输出
  - 需要支持日志级别配置
  
- **F9.2** 性能监测
  - 需要记录API调用时间
  - 需要记录工具执行时间
  - 需要实现性能报告

---

### 1.2 非功能需求

#### 性能需求 P1
- **P1.1** 响应时间
  - 单个工具调用应在 < 5 秒内完成
  - API调用应包含超时保护（30秒）
  - 文件读取应支持 < 10MB 文件的快速处理
  
- **P1.2** 并发处理
  - 应支持异步调用
  - 应支持同时处理多个请求
  - 应实现连接池管理

#### 可靠性需求 P2
- **P2.1** 错误处理
  - 所有API调用应有重试机制（指数退避）
  - 所有文件操作应有异常捕获
  - 应提供清晰的错误消息
  
- **P2.2** 容错能力
  - 单个工具失败不应中断整个流程
  - 应支持部分失败恢复
  - 应实现自动重连机制

#### 安全性需求 P3
- **P3.1** 信息安全
  - API密钥不应出现在日志中
  - 不应存储用户代码在不安全位置
  - 应支持本地加密存储
  
- **P3.2** 操作安全
  - 不应允许随意执行系统命令
  - 文件删除应有保护机制
  - 应实现操作审计日志

#### 可扩展性需求 P4
- **P4.1** 模块化设计
  - 应支持自定义工具注册
  - 应支持自定义系统提示词
  - 应支持插件机制
  
- **P4.2** 易于集成
  - 应提供清晰的API接口
  - 应支持多种配置方式
  - 应兼容主流Python框架

#### 可维护性需求 P5
- **P5.1** 代码质量
  - 应遵循PEP8代码规范
  - 应具有完整的类型注解
  - 应有充分的代码注释
  
- **P5.2** 文档完整性
  - 应有完整的API文档
  - 应有详细的使用示例
  - 应有架构设计文档

#### 兼容性需求 P6
- **P6.1** Python版本
  - 应支持Python 3.8+
  - 应支持多个操作系统
  
- **P6.2** 模型兼容性
  - 应适配Claude最新API版本
  - 应适配OpenAI最新API版本
  - 应支持Ollama本地部署

---

### 1.3 用户故事与场景

#### 场景 U1：开发者快速生成代码
> 作为一名Python开发者，我需要使用AI代理快速生成某个功能的代码框架，这样可以提高开发效率。

**需要的功能**:
- 能接收自然语言描述
- 能生成完整的代码文件
- 能将代码集成到项目中

#### 场景 U2：代码审查与优化
> 作为一名代码审查员，我需要AI代理分析现有代码，提出优化建议，这样可以改进代码质量。

**需要的功能**:
- 能读取并理解代码
- 能搜索相关的代码片段
- 能生成优化建议

#### 场景 U3：跨项目代码搜索
> 作为一名维护人员，我需要在代码库中搜索特定的函数或类定义，这样可以快速定位问题。

**需要的功能**:
- 支持强大的代码搜索
- 支持跨文件搜索
- 支持模糊匹配

#### 场景 U4：自动化工作流
> 作为一名DevOps工程师，我需要构建自动化脚本来处理重复任务，使用AI代理简化这个过程。

**需要的功能**:
- 支持链式任务执行
- 支持自动继续模式
- 支持权限控制

---

## 2️⃣ 系统架构设计

### 2.1 整体架构

```
┌─────────────────────────────────────────────┐
│          CLI/API 接口层                      │
│  (interact.py - 用户交互入口)               │
└────────────────┬────────────────────────────┘
                 │
┌────────────────▼────────────────────────────┐
│       工厂模式 & 配置层                      │
│  (factory.py - 模型实例化)                  │
│  (permissions.py - 权限管理)                │
└────────────────┬────────────────────────────┘
                 │
        ┌────────┴────────┬──────────┬──────────┐
        │                 │          │          │
    ┌───▼──────┐    ┌────▼────┐ ┌──▼────┐  ┌──▼──────┐
    │Claude    │    │OpenAI   │ │Ollama │  │Base     │
    │Agent     │    │         │ │      │  │         │
    │(base.py) │    │         │ │      │  │         │
    └───┬──────┘    └────┬────┘ └──┬───┘  └──┬──────┘
        │                │         │        │
        └────────────────┼─────────┼────────┘
                         │
        ┌────────────────▼────────────────┐
        │     工具执行引擎                 │
        │  (register_tools.py)            │
        │  - 工具注册                     │
        │  - 工具调用                     │
        │  - 结果处理                     │
        └────────────────┬────────────────┘
                         │
    ┌────────────────────┼────────────────────┐
    │                    │                    │
┌───▼──────────┐   ┌────▼────────┐   ┌──────▼───┐
│ File Tools   │   │ Search Tools │   │System    │
│              │   │              │   │Tools     │
├──────────────┤   ├──────────────┤   ├──────────┤
│ read_file    │   │codebase_search
│ edit_file    │   │grep_search   │   │run_cmd   │
│ delete_file  │   │file_search   │   │         │
│ list_dir     │   │web_search    │   │         │
│ create_file  │   │trend_search  │   │         │
└──────────────┘   └──────────────┘   └──────────┘
```

### 2.2 数据流转

```
用户输入
    ↓
┌─────────────────────────────────┐
│ 1. 格式化请求                   │
│    - 添加系统提示               │
│    - 准备工具定义               │
│    - 添加上下文                 │
└─────────────────────────────────┘
    ↓
┌─────────────────────────────────┐
│ 2. 发送到AI模型                 │
│    - Claude API                 │
│    - OpenAI API                 │
│    - Ollama Local               │
└─────────────────────────────────┘
    ↓
┌─────────────────────────────────┐
│ 3. 解析模型响应                 │
│    - 提取文本响应               │
│    - 提取工具调用               │
│    - 格式统一化                 │
└─────────────────────────────────┘
    ↓
┌─────────────────────────────────┐
│ 4. 执行工具调用                 │
│    - 权限检查                   │
│    - 参数验证                   │
│    - 工具执行                   │
│    - 错误处理                   │
└─────────────────────────────────┘
    ↓
┌─────────────────────────────────┐
│ 5. 循环继续（如有新的工具调用） │
│    或返回最终结果               │
└─────────────────────────────────┘
    ↓
用户获得结果
```

### 2.3 关键模块设计

#### 基础Agent类 (base.py)
```python
BaseAgent:
  - __init__(model, temperature, system_prompt)
  - chat(user_message, user_info)
  - register_tool(name, function, description, parameters)
  - _prepare_tools()
  - _execute_tool_calls(tool_calls)
  - _handle_api_response(response)
```

#### Claude代理 (claude_agent.py)
```python
ClaudeAgent(BaseAgent):
  - 继承BaseAgent
  - 实现Claude特定的消息格式
  - 处理tool_use内容块
  - 管理conversation history
```

#### OpenAI代理 (openai_agent.py)
```python
OpenAIAgent(BaseAgent):
  - 继承BaseAgent
  - 实现OpenAI特定的消息格式
  - 处理function_calling
  - 管理token计数
```

#### Ollama代理 (ollama_agent.py)
```python
OllamaAgent(BaseAgent):
  - 继承BaseAgent
  - 支持本地模型连接
  - 处理本地推理
  - 管理模型生命周期
```

---

## 3️⃣ 技术栈与依赖

### 核心依赖
```
anthropic>=0.49.0          # Claude API
openai>=1.6.1              # OpenAI API
ollama>=0.4.0              # Ollama本地模型
python-dotenv>=1.0.0       # 环境变量管理
requests>=2.31.0           # HTTP请求
httpx>=0.25.0              # 异步HTTP
colorama>=0.4.6            # 彩色输出
beautifulsoup4>=4.12.0     # HTML解析
```

### 开发依赖
```
pytest>=7.0.0              # 测试框架
pytest-cov>=4.0.0          # 覆盖率
black>=23.0.0              # 代码格式化
isort>=5.12.0              # 导入排序
flake8>=6.0.0              # 代码检查
mypy>=1.0.0                # 类型检查
```

---

## 4️⃣ 部署与发行

### 发行策略
- 将项目发布到PyPI作为pip包
- 支持从源码安装（开发模式）
- 提供Docker容器镜像
- 发布到Conda

### 环境配置
```ini
# .env 文件示例
ANTHROPIC_API_KEY=your_key
OPENAI_API_KEY=your_key
OLLAMA_HOST=http://localhost:11434
ENVIRONMENT=local
```

---

## 5️⃣ 成功指标与验收标准

| 模块 | 验收标准 |
|------|---------|
| **F1 多模型支持** | 三种模型都能正常调用，切换无缝 |
| **F2 文件操作** | 所有文件操作都能正确执行并有错误处理 |
| **F3 代码搜索** | 能准确搜索到目标代码片段 |
| **F4 工具调用** | 工具能正确被模型识别和调用 |
| **F5 对话管理** | 能维持多轮对话的上下文 |
| **F6 权限系统** | 权限检查生效，危险操作被拦截 |
| **F7 交互模式** | CLI能友好地展示执行过程 |
| **F8 图像分析** | 能正确处理图像文件 |
| **P1 性能** | 单次调用 < 5秒，支持并发 |
| **P2 可靠性** | 错误率 < 1%，有重试机制 |
| **P3 安全性** | 敏感信息不泄露，权限严格 |
| **测试覆盖率** | ≥ 80% |
| **文档完整性** | API文档 + 使用示例完整 |

---

## 6️⃣ 风险评估

| 风险 | 影响 | 概率 | 缓解方案 |
|------|------|------|---------|
| API调用失败 | 高 | 中 | 实现重试和降级策略 |
| 上下文窗口溢出 | 中 | 中 | 实现历史压缩和摘要 |
| 模型格式不一致 | 中 | 中 | 建立统一的消息格式 |
| 安全漏洞 | 高 | 低 | 严格的权限检查和审计 |
| 依赖版本冲突 | 低 | 低 | 锁定依赖版本范围 |

---
